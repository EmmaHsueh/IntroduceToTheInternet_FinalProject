# å¸«è² NTNU Talk - æŠ€è¡“æ¶æ§‹èˆ‡å¯¦ä½œè¬›è§£

## ğŸ“Š ç³»çµ±æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä½¿ç”¨è€…ä»‹é¢                              â”‚
â”‚                    React Frontend (Port 3000)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ HTTP/HTTPS
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¾Œç«¯ API æœå‹™å±¤                              â”‚
â”‚              Node.js + Express (Port 10000)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å…§å®¹å¯©æ ¸      â”‚ åœ–ç‰‡å»èƒŒ      â”‚ RAG çŸ¥è­˜åº«ç³»çµ±             â”‚ â”‚
â”‚  â”‚ /moderation  â”‚ /remove-bg   â”‚ /api/rag-test            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase      â”‚ â”‚ External     â”‚ â”‚ AI/ML Services  â”‚
â”‚ - Auth        â”‚ â”‚ APIs         â”‚ â”‚ - Perspective   â”‚
â”‚ - Firestore   â”‚ â”‚ - Remove.bg  â”‚ â”‚ - RAG Vector    â”‚
â”‚ - Storage     â”‚ â”‚ - MyMemory   â”‚ â”‚   Retrieval     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸€ã€å‰ç«¯æ¶æ§‹ (React)

### 1.1 æŠ€è¡“æ£§

```javascript
{
  "æ ¸å¿ƒæ¡†æ¶": "React 18.2.0",
  "è·¯ç”±": "React Router 7.9.5",
  "ç‹€æ…‹ç®¡ç†": "Context API",
  "UI": "å…§è¯æ¨£å¼ + è‡ªå®šç¾©è¨­è¨ˆç³»çµ±",
  "å¾Œç«¯é€šè¨Š": "Fetch API",
  "èªè­‰": "Firebase Auth",
  "æ•¸æ“šåº«": "Firebase Firestore"
}
```

### 1.2 ç›®éŒ„çµæ§‹

```
src/
â”œâ”€â”€ components/          # å¯é‡ç”¨çµ„ä»¶
â”‚   â”œâ”€â”€ Header.js       # å°èˆªæ¬„
â”‚   â”œâ”€â”€ BoardNav.js     # çœ‹æ¿å°èˆª
â”‚   â”œâ”€â”€ BoardTemplate.js # çœ‹æ¿æ¨¡æ¿ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”œâ”€â”€ ChatWidget.js   # å³æ™‚èŠå¤©å®¤
â”‚   â”œâ”€â”€ PostForm.js     # ç™¼æ–‡è¡¨å–®
â”‚   â””â”€â”€ Icons.js        # åœ–æ¨™çµ„ä»¶
â”œâ”€â”€ contexts/           # Context API ç‹€æ…‹ç®¡ç†
â”‚   â”œâ”€â”€ AuthContext.js      # èªè­‰ç‹€æ…‹
â”‚   â””â”€â”€ LanguageContext.js  # èªè¨€åˆ‡æ›
â”œâ”€â”€ pages/              # é é¢çµ„ä»¶
â”‚   â”œâ”€â”€ HomePage.js         # é¦–é 
â”‚   â”œâ”€â”€ LoginPage.js        # ç™»å…¥é 
â”‚   â”œâ”€â”€ MatchingPage.js     # æ™ºæ…§é…å°
â”‚   â”œâ”€â”€ BoardsIndexPage.js  # çœ‹æ¿å°èˆªé 
â”‚   â”œâ”€â”€ FoodBoardPage.js    # ç¾é£Ÿçœ‹æ¿ï¼ˆä½¿ç”¨ BoardTemplateï¼‰
â”‚   â””â”€â”€ ...å…¶ä»–çœ‹æ¿é é¢
â”œâ”€â”€ services/           # æ¥­å‹™é‚è¼¯
â”‚   â”œâ”€â”€ postService.js  # è²¼æ–‡ CRUD
â”‚   â””â”€â”€ chatService.js  # èŠå¤©å®¤æœå‹™
â””â”€â”€ firebase.js         # Firebase é…ç½®
```

### 1.3 æ ¸å¿ƒæ¶æ§‹æ¨¡å¼ï¼šTemplate Pattern

**é—œéµè¨­è¨ˆï¼šBoardTemplate çµ„ä»¶**

æ‰€æœ‰çœ‹æ¿é é¢å…±ç”¨ä¸€å€‹æ¨¡æ¿ï¼Œé¿å…ä»£ç¢¼é‡è¤‡ï¼š

```javascript
// src/components/BoardTemplate.js (ç°¡åŒ–ç‰ˆ)
const BoardTemplate = ({ boardName }) => {
  const [posts, setPosts] = useState([]);
  const [showChat, setShowChat] = useState(false);

  // ğŸ”¥ é‡é» 1: å¯¦æ™‚ç›£è½ Firestore
  useEffect(() => {
    const unsubscribe = listenToPosts(boardName, (newPosts) => {
      setPosts(newPosts);
    });
    return () => unsubscribe(); // æ¸…ç†è¨‚é–±
  }, [boardName]);

  return (
    <>
      <Header />
      <BoardNav />

      {/* çœ‹æ¿æ¨™é¡Œ */}
      <h1>ã€{boardName}ã€‘çœ‹æ¿è¨è«–å€</h1>

      {/* ç™¼æ–‡æŒ‰éˆ• */}
      <button onClick={() => setShowPostForm(true)}>
        + ç™¼è¡¨æ–°è²¼æ–‡
      </button>

      {/* èŠå¤©å®¤æŒ‰éˆ• */}
      <button onClick={() => setShowChat(!showChat)}>
        ğŸ’¬ å³æ™‚èŠå¤©å®¤
      </button>

      {/* è²¼æ–‡åˆ—è¡¨ */}
      {posts.map(post => (
        <Post key={post.id} post={post} />
      ))}

      {/* èŠå¤©å®¤ Widget */}
      {showChat && <ChatWidget boardName={boardName} />}
    </>
  );
};
```

**ä½¿ç”¨ç¯„ä¾‹ï¼š**

```javascript
// src/pages/FoodBoardPage.js
const FoodBoardPage = () => {
  return <BoardTemplate boardName="Food" />;
};

// src/pages/EventsBoardPage.js
const EventsBoardPage = () => {
  return <BoardTemplate boardName="Events" />;
};
```

### 1.4 å…¨å±€ç‹€æ…‹ç®¡ç†ï¼šContext API

#### AuthContext - èªè­‰ç‹€æ…‹ç®¡ç†

```javascript
// src/contexts/AuthContext.js (é‡é»ä»£ç¢¼)
export const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [currentUser, setCurrentUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);

  // ğŸ”¥ ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setCurrentUser(user);

      if (user) {
        // å¾ Firestore åŠ è¼‰ç”¨æˆ¶è³‡æ–™
        await loadUserProfile(user.uid);
      } else {
        setUserProfile(null);
      }
    });

    return unsubscribe;
  }, []);

  // ğŸ”¥ è¨»å†Šæ–°ç”¨æˆ¶
  const signup = async (email, password, nickname) => {
    const userCredential = await createUserWithEmailAndPassword(
      auth, email, password
    );

    // åœ¨ Firestore å‰µå»ºç”¨æˆ¶è³‡æ–™
    await setDoc(doc(db, 'users', userCredential.user.uid), {
      uid: userCredential.user.uid,
      email: email,
      nickname: nickname,
      createdAt: new Date()
    });
  };

  const value = {
    currentUser,
    userProfile,
    signup,
    login,
    logout,
    // ...å…¶ä»–æ–¹æ³•
  };

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};

// è‡ªå®šç¾© Hook
export const useAuth = () => {
  return useContext(AuthContext);
};
```

#### LanguageContext - å¤šèªè¨€æ”¯æ´

```javascript
// src/contexts/LanguageContext.js (é‡é»ä»£ç¢¼)
export const LanguageContext = createContext();

export const LanguageProvider = ({ children }) => {
  // ğŸ”¥ å¾ localStorage è®€å–èªè¨€è¨­å®š
  const [language, setLanguage] = useState(() => {
    return localStorage.getItem('appLanguage') || 'en';
  });

  // ğŸ”¥ æŒä¹…åŒ–èªè¨€è¨­å®š
  useEffect(() => {
    localStorage.setItem('appLanguage', language);
  }, [language]);

  const value = {
    language,
    setLanguage,
    isEnglish: language === 'en',
    isChinese: language === 'zh',
  };

  return (
    <LanguageContext.Provider value={value}>
      {children}
    </LanguageContext.Provider>
  );
};
```

### 1.5 è·¯ç”±ç³»çµ±

```javascript
// src/App.js (è·¯ç”±é…ç½®)
function App() {
  return (
    <LanguageProvider>
      <AuthProvider>
        <Router>
          <Routes>
            {/* å…¬é–‹è·¯ç”± */}
            <Route path="/" element={<HomePage />} />
            <Route path="/login" element={<LoginPage />} />
            <Route path="/boards" element={<BoardsIndexPage />} />

            {/* çœ‹æ¿è·¯ç”± */}
            <Route path="/boards/food" element={<FoodBoardPage />} />
            <Route path="/boards/events" element={<EventsBoardPage />} />
            {/* ...å…¶ä»–çœ‹æ¿ */}

            {/* å‹•æ…‹è·¯ç”± */}
            <Route path="/boards/:boardId/:postId"
                   element={<PostDetailPage />} />

            {/* åŠŸèƒ½è·¯ç”± */}
            <Route path="/matching" element={<MatchingPage />} />
            <Route path="/events-map" element={<EventMapPage />} />
            <Route path="/profile" element={<ProfilePage />} />
          </Routes>

          <AITalk /> {/* å…¨å±€ AI åŠ©æ‰‹ */}
        </Router>
      </AuthProvider>
    </LanguageProvider>
  );
}
```

---

## ğŸ”§ äºŒã€å¾Œç«¯æ¶æ§‹ (Node.js + Express)

### 2.1 æŠ€è¡“æ£§

```javascript
{
  "é‹è¡Œç’°å¢ƒ": "Node.js",
  "Web æ¡†æ¶": "Express.js",
  "æ–‡ä»¶ä¸Šå‚³": "Multer",
  "HTTP å®¢æˆ¶ç«¯": "Axios",
  "éƒ¨ç½²å¹³å°": "Render",
  "ç’°å¢ƒè®Šæ•¸": "dotenv"
}
```

### 2.2 Server.js çµæ§‹è§£æ

```javascript
// backend/server.js (å®Œæ•´æ¶æ§‹)

const express = require('express');
const cors = require('cors');
const multer = require('multer');
const axios = require('axios');
const fs = require('fs');
const path = require('path');

const app = express();

// ============================================
// 1ï¸âƒ£ ä¸­é–“ä»¶é…ç½®
// ============================================

// CORS é…ç½®ï¼ˆå…è¨±å‰ç«¯è·¨åŸŸè«‹æ±‚ï¼‰
app.use(cors());

// JSON è§£æ
app.use(express.json({ limit: '50mb' }));

// æ–‡ä»¶ä¸Šå‚³é…ç½®ï¼ˆä½¿ç”¨è¨˜æ†¶é«”å­˜å„²ï¼‰
const upload = multer({ storage: multer.memoryStorage() });

// ============================================
// 2ï¸âƒ£ RAG çŸ¥è­˜åº«ç³»çµ±ï¼ˆAI é›†æˆï¼‰
// ============================================

let KNOWLEDGE_BASE = [];

// ğŸ”¥ è¼‰å…¥çŸ¥è­˜åº«æ–‡ä»¶
function loadKnowledgeBase() {
  const content = fs.readFileSync('knowledge_base.txt', 'utf-8');
  const lines = content.split('\n');

  for (const line of lines) {
    if (line.trim().startsWith('#') || !line.trim()) continue;

    // è§£ææ ¼å¼: [åˆ†é¡] å•é¡Œ | ç­”æ¡ˆ
    const match = line.match(/\[(.+?)\]\s*(.+?)\s*\|\s*(.+)/);
    if (match) {
      const [, category, question, answer] = match;
      KNOWLEDGE_BASE.push({
        category,
        question,
        answer,
        text: `${question} ${answer}`,
        vector: textToVector(`${question} ${answer}`)
      });
    }
  }

  console.log(`âœ… è¼‰å…¥ ${KNOWLEDGE_BASE.length} æ¢çŸ¥è­˜`);
}

// ğŸ”¥ æ–‡æœ¬å‘é‡åŒ–ï¼ˆTF-IDFï¼‰
function textToVector(text) {
  const tokens = simpleTokenize(text);
  return computeTF(tokens);
}

// ğŸ”¥ é¤˜å¼¦ç›¸ä¼¼åº¦è¨ˆç®—
function cosineSimilarity(vec1, vec2) {
  const allKeys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);
  let dotProduct = 0, mag1 = 0, mag2 = 0;

  for (const key of allKeys) {
    const v1 = vec1[key] || 0;
    const v2 = vec2[key] || 0;
    dotProduct += v1 * v2;
    mag1 += v1 * v1;
    mag2 += v2 * v2;
  }

  return dotProduct / (Math.sqrt(mag1) * Math.sqrt(mag2));
}

// ğŸ”¥ RAG æª¢ç´¢å‡½æ•¸
const retrieveFacts = (message, role = null, topK = 3) => {
  const queryVector = textToVector(message);

  // è¨ˆç®—ç›¸ä¼¼åº¦
  const results = KNOWLEDGE_BASE.map(item => ({
    ...item,
    similarity: cosineSimilarity(queryVector, item.vector)
  }));

  // æ’åºä¸¦éæ¿¾
  results.sort((a, b) => b.similarity - a.similarity);
  const filtered = results.filter(r => r.similarity > 0.1);

  return filtered.slice(0, topK).map(r => r.answer);
};

// å•Ÿå‹•æ™‚è¼‰å…¥çŸ¥è­˜åº«
loadKnowledgeBase();

// ============================================
// 3ï¸âƒ£ API ç«¯é»
// ============================================

// ğŸ”¥ å…§å®¹å¯©æ ¸ API (Google Perspective)
app.post("/moderation", async (req, res) => {
  const { content } = req.body;

  try {
    const response = await axios.post(
      `${DISCOVERY_URL}`,
      {
        comment: { text: content },
        languages: ["zh", "en"],
        requestedAttributes: {
          TOXICITY: {},
          SEVERE_TOXICITY: {},
          THREAT: {},
          INSULT: {},
          PROFANITY: {},
          IDENTITY_ATTACK: {}
        }
      },
      {
        params: { key: PERSPECTIVE_API_KEY }
      }
    );

    // æª¢æŸ¥æ˜¯å¦é•è¦
    const scores = response.data.attributeScores;
    let flagged = false;
    const violations = [];

    for (const [attr, data] of Object.entries(scores)) {
      if (data.summaryScore.value >= THRESHOLD) {
        flagged = true;
        violations.push(ATTRIBUTE_MAPPING[attr]);
      }
    }

    res.json({ flagged, categories: violations });

  } catch (error) {
    console.error("å¯©æ ¸å¤±æ•—:", error);
    res.status(500).json({ error: "å¯©æ ¸å¤±æ•—" });
  }
});

// ğŸ”¥ åœ–ç‰‡å»èƒŒ API (Remove.bg Proxy)
app.post("/remove-bg", upload.single("image_file"), async (req, res) => {
  try {
    const formData = new FormData();
    formData.append("image_file", req.file.buffer, req.file.originalname);
    formData.append("size", "auto");

    const response = await axios.post(
      "https://api.remove.bg/v1.0/removebg",
      formData,
      {
        headers: {
          ...formData.getHeaders(),
          "X-Api-Key": REMOVE_BG_API_KEY
        },
        responseType: "arraybuffer"
      }
    );

    res.set("Content-Type", "image/png");
    res.send(response.data);

  } catch (error) {
    console.error("å»èƒŒå¤±æ•—:", error);
    res.status(500).json({ error: "å»èƒŒè™•ç†å¤±æ•—" });
  }
});

// ğŸ”¥ RAG æ¸¬è©¦ç«¯é»
app.post("/api/rag-test", async (req, res) => {
  const { question, topK = 3 } = req.body;

  const facts = retrieveFacts(question, null, topK);

  res.json({
    success: true,
    question,
    results: facts,
    count: facts.length
  });
});

// ============================================
// 4ï¸âƒ£ å•Ÿå‹•æœå‹™å™¨
// ============================================

const PORT = process.env.PORT || 10000;
const HOST = '0.0.0.0'; // Render éƒ¨ç½²å¿…é ˆ

app.listen(PORT, HOST, () => {
  console.log(`Server running on http://${HOST}:${PORT}`);
});
```

---

## ğŸ’¾ ä¸‰ã€æ•¸æ“šåº«æ¶æ§‹ (Firebase Firestore)

### 3.1 Firestore é›†åˆçµæ§‹

```
ntnu-talk (Project)
â”‚
â”œâ”€â”€ users/                    # ç”¨æˆ¶é›†åˆ
â”‚   â””â”€â”€ {userId}              # æ–‡æª” ID = Firebase Auth UID
â”‚       â”œâ”€â”€ uid: string
â”‚       â”œâ”€â”€ email: string
â”‚       â”œâ”€â”€ nickname: string
â”‚       â”œâ”€â”€ avatar: string?
â”‚       â”œâ”€â”€ bio: string?
â”‚       â”œâ”€â”€ createdAt: Timestamp
â”‚       â””â”€â”€ ...å…¶ä»–æ¬„ä½
â”‚
â”œâ”€â”€ posts/                    # è²¼æ–‡é›†åˆ
â”‚   â””â”€â”€ {postId}              # è‡ªå‹•ç”Ÿæˆçš„æ–‡æª” ID
â”‚       â”œâ”€â”€ title: string
â”‚       â”œâ”€â”€ content: string
â”‚       â”œâ”€â”€ boardName: string      # æ‰€å±¬çœ‹æ¿
â”‚       â”œâ”€â”€ authorId: string       # ä½œè€… UID
â”‚       â”œâ”€â”€ authorName: string
â”‚       â”œâ”€â”€ imageUrls: array       # åœ–ç‰‡é™£åˆ—
â”‚       â”œâ”€â”€ createdAt: Timestamp
â”‚       â”œâ”€â”€ commentCount: number
â”‚       â””â”€â”€ comments: array        # ç•™è¨€é™£åˆ—
â”‚           â””â”€â”€ [
â”‚               {
â”‚                 author: string,
â”‚                 content: string,
â”‚                 date: string,
â”‚                 id: string
â”‚               }
â”‚             ]
â”‚
â””â”€â”€ chatMessages/             # èŠå¤©è¨Šæ¯é›†åˆ
    â””â”€â”€ {messageId}           # è‡ªå‹•ç”Ÿæˆçš„æ–‡æª” ID
        â”œâ”€â”€ boardName: string      # æ‰€å±¬çœ‹æ¿
        â”œâ”€â”€ sender: string
        â”œâ”€â”€ senderId: string
        â”œâ”€â”€ content: string
        â”œâ”€â”€ createdAt: Timestamp
        â””â”€â”€ expiresAt: Timestamp   # 30 å¤©å¾ŒéæœŸ
```

### 3.2 Firestore æ“ä½œå¯¦ä¾‹

#### postService.js - è²¼æ–‡æœå‹™

```javascript
// src/services/postService.js (é‡é»ä»£ç¢¼)

import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  updateDoc,
  doc,
  getDoc,
  serverTimestamp
} from 'firebase/firestore';
import { db } from '../firebase';

// ğŸ”¥ å¯¦æ™‚ç›£è½è²¼æ–‡ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
export const listenToPosts = (boardName, callback) => {
  const postsRef = collection(db, 'posts');

  // æ§‹å»ºæŸ¥è©¢ï¼šéæ¿¾çœ‹æ¿ + æŒ‰æ™‚é–“æ’åº
  const q = query(
    postsRef,
    where('boardName', '==', boardName),
    orderBy('createdAt', 'desc')
  );

  // è¨­ç½®å¯¦æ™‚ç›£è½å™¨
  const unsubscribe = onSnapshot(q, (snapshot) => {
    const posts = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    callback(posts); // å›èª¿å‡½æ•¸æ›´æ–° UI
  });

  return unsubscribe; // è¿”å›å–æ¶ˆè¨‚é–±å‡½æ•¸
};

// ğŸ”¥ å‰µå»ºæ–°è²¼æ–‡
export const createPost = async (postData) => {
  const postsRef = collection(db, 'posts');

  const newPost = {
    ...postData,
    createdAt: serverTimestamp(), // ä½¿ç”¨æœå‹™å™¨æ™‚é–“æˆ³
    commentCount: 0,
    comments: []
  };

  const docRef = await addDoc(postsRef, newPost);
  return docRef.id;
};

// ğŸ”¥ æ–°å¢ç•™è¨€
export const addCommentToPost = async (postId, comment) => {
  const postRef = doc(db, 'posts', postId);

  // ç²å–ç•¶å‰è²¼æ–‡
  const postSnap = await getDoc(postRef);
  const currentComments = postSnap.data().comments || [];

  // æ›´æ–°ç•™è¨€å’Œè¨ˆæ•¸
  await updateDoc(postRef, {
    comments: [...currentComments, comment],
    commentCount: currentComments.length + 1
  });
};
```

#### chatService.js - èŠå¤©å®¤æœå‹™

```javascript
// src/services/chatService.js (é‡é»ä»£ç¢¼)

import {
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  addDoc,
  deleteDoc,
  getDocs,
  serverTimestamp,
  Timestamp
} from 'firebase/firestore';

// ğŸ”¥ å¯¦æ™‚ç›£è½èŠå¤©è¨Šæ¯
export const listenToChatMessages = (boardName, callback) => {
  const messagesRef = collection(db, 'chatMessages');

  const q = query(
    messagesRef,
    where('boardName', '==', boardName),
    orderBy('createdAt', 'asc') // æŒ‰æ™‚é–“å‡åº
  );

  return onSnapshot(q, (snapshot) => {
    const messages = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(messages);
  });
};

// ğŸ”¥ ç™¼é€èŠå¤©è¨Šæ¯
export const sendChatMessage = async (boardName, sender, senderId, content) => {
  const messagesRef = collection(db, 'chatMessages');

  // è¨ˆç®—éæœŸæ™‚é–“ï¼ˆ30 å¤©å¾Œï¼‰
  const now = new Date();
  const expiresAt = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

  await addDoc(messagesRef, {
    boardName,
    sender,
    senderId,
    content,
    createdAt: serverTimestamp(),
    expiresAt: Timestamp.fromDate(expiresAt)
  });
};

// ğŸ”¥ æ¸…ç†éæœŸè¨Šæ¯
export const cleanupExpiredMessages = async () => {
  const messagesRef = collection(db, 'chatMessages');
  const now = Timestamp.now();

  const q = query(
    messagesRef,
    where('expiresAt', '<', now)
  );

  const snapshot = await getDocs(q);

  let count = 0;
  for (const doc of snapshot.docs) {
    await deleteDoc(doc.ref);
    count++;
  }

  return count;
};
```

---

## ğŸŒ å››ã€å¤–éƒ¨ API æ•´åˆ

### 4.1 Google Perspective API - å…§å®¹å¯©æ ¸

**ç”¨é€”ï¼š** åµæ¸¬æƒ¡æ„ã€å¨è„…ã€ä¾®è¾±ç­‰ä¸ç•¶è¨€è«–

```javascript
// å¯©æ ¸æµç¨‹
ç”¨æˆ¶ç™¼æ–‡/ç•™è¨€
    â†“
å‰ç«¯èª¿ç”¨ /moderation ç«¯é»
    â†“
å¾Œç«¯è½‰ç™¼åˆ° Google Perspective API
    â†“
åˆ†æ 6 ç¨®å±¬æ€§ï¼ˆæƒ¡æ„ã€å¨è„…ã€ä¾®è¾±...ï¼‰
    â†“
è¿”å›åˆ†æ•¸ (0-1)
    â†“
è¶…éé–¾å€¼ (0.5) â†’ é˜»æ“‹ç™¼å¸ƒ
    â†“
æœªè¶…é â†’ å…è¨±ç™¼å¸ƒ
```

**é—œéµä»£ç¢¼ï¼š**

```javascript
// å‰ç«¯èª¿ç”¨
const moderationCheck = async (content) => {
  const response = await fetch(`${BACKEND_URL}/moderation`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content })
  });

  const { flagged, categories } = await response.json();

  if (flagged) {
    alert(`å…§å®¹é•è¦ï¼š${categories.join(', ')}`);
    return false;
  }
  return true;
};
```

### 4.2 Remove.bg API - åœ–ç‰‡å»èƒŒ

**ç”¨é€”ï¼š** è‡ªå‹•å»é™¤åœ–ç‰‡èƒŒæ™¯

```javascript
// å‰ç«¯ä½¿ç”¨
const handleRemoveBackground = async (file) => {
  const formData = new FormData();
  formData.append('image_file', file);

  const response = await fetch(`${BACKEND_URL}/remove-bg`, {
    method: 'POST',
    body: formData
  });

  const blob = await response.blob();
  const imageUrl = URL.createObjectURL(blob);

  return imageUrl;
};
```

### 4.3 MyMemory Translation API - ç¿»è­¯æœå‹™

**ç”¨é€”ï¼š** ä¸­è‹±æ–‡ç¿»è­¯

```javascript
// å¾Œç«¯å¯¦ç¾
app.post("/translate", async (req, res) => {
  const { title, content } = req.body;

  const translateText = async (text) => {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh|en`;
    const response = await axios.get(url);
    return response.data.responseData.translatedText;
  };

  const translatedTitle = await translateText(title);
  const translatedContent = await translateText(content);

  res.json({ translatedTitle, translatedContent });
});
```

---

## ğŸ¤– äº”ã€AI æ•´åˆ - RAG çŸ¥è­˜åº«ç³»çµ±

### 5.1 RAG æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RAG æª¢ç´¢æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ çŸ¥è­˜åº«è¼‰å…¥éšæ®µï¼ˆå•Ÿå‹•æ™‚åŸ·è¡Œä¸€æ¬¡ï¼‰
   â”œâ”€ è®€å– knowledge_base.txt
   â”œâ”€ è§£ææ¯è¡Œï¼š[åˆ†é¡] å•é¡Œ | ç­”æ¡ˆ
   â”œâ”€ æ–‡æœ¬å‘é‡åŒ–ï¼ˆTF-IDFï¼‰
   â””â”€ å­˜å„²åœ¨è¨˜æ†¶é«”

2ï¸âƒ£ æŸ¥è©¢éšæ®µï¼ˆæ¯æ¬¡ç”¨æˆ¶æå•ï¼‰
   â”œâ”€ ç”¨æˆ¶å•é¡Œ â†’ å‘é‡åŒ–
   â”œâ”€ è¨ˆç®—é¤˜å¼¦ç›¸ä¼¼åº¦ï¼ˆèˆ‡æ‰€æœ‰çŸ¥è­˜æ¯”å°ï¼‰
   â”œâ”€ æ’åºï¼ˆç›¸ä¼¼åº¦å¾é«˜åˆ°ä½ï¼‰
   â”œâ”€ éæ¿¾ï¼ˆç›¸ä¼¼åº¦ > 0.1ï¼‰
   â””â”€ è¿”å›å‰ topK æ¢ï¼ˆé è¨­ 3 æ¢ï¼‰

3ï¸âƒ£ æ•´åˆéšæ®µï¼ˆèˆ‡ LLM çµåˆï¼‰
   â”œâ”€ æª¢ç´¢åˆ°çš„çŸ¥è­˜ä½œç‚º Context
   â”œâ”€ æ§‹å»ºå¢å¼·çš„ Prompt
   â””â”€ LLM åŸºæ–¼ Context ç”Ÿæˆå›ç­”
```

### 5.2 æ ¸å¿ƒæ¼”ç®—æ³•

#### åˆ†è©ï¼ˆTokenizationï¼‰

```javascript
function simpleTokenize(text) {
  // ç§»é™¤æ¨™é»ç¬¦è™Ÿ
  const cleaned = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, ' ');
  const tokens = [];

  // ä¸­æ–‡ï¼šæ¯å€‹å­—ä½œç‚ºä¸€å€‹ token
  for (let i = 0; i < cleaned.length; i++) {
    const char = cleaned[i];
    if (/[\u4e00-\u9fa5]/.test(char)) {
      tokens.push(char);
    }
  }

  // è‹±æ–‡ï¼šæŒ‰è©åˆ†å‰²
  const words = cleaned.match(/[a-zA-Z0-9]+/g) || [];
  tokens.push(...words.map(w => w.toLowerCase()));

  return tokens;
}

// ç¯„ä¾‹
simpleTokenize("é¸èª²æœ‰å“ªäº›éšæ®µï¼Ÿ")
// â†’ ["é¸", "èª²", "æœ‰", "å“ª", "äº›", "éš", "æ®µ"]
```

#### è©é »è¨ˆç®—ï¼ˆTFï¼‰

```javascript
function computeTF(tokens) {
  const tf = {};
  const totalTokens = tokens.length;

  // è¨ˆæ•¸
  for (const token of tokens) {
    tf[token] = (tf[token] || 0) + 1;
  }

  // æ¨™æº–åŒ–ï¼ˆé™¤ä»¥ç¸½æ•¸ï¼‰
  for (const token in tf) {
    tf[token] = tf[token] / totalTokens;
  }

  return tf;
}

// ç¯„ä¾‹
computeTF(["é¸", "èª²", "é¸", "èª²"])
// â†’ { "é¸": 0.5, "èª²": 0.5 }
```

#### é¤˜å¼¦ç›¸ä¼¼åº¦

```javascript
function cosineSimilarity(vec1, vec2) {
  // vec1 = { "é¸": 0.5, "èª²": 0.5 }
  // vec2 = { "é¸": 0.3, "èª²": 0.3, "æœ‰": 0.4 }

  const allKeys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);
  let dotProduct = 0;
  let mag1 = 0;
  let mag2 = 0;

  for (const key of allKeys) {
    const v1 = vec1[key] || 0;
    const v2 = vec2[key] || 0;

    dotProduct += v1 * v2;  // é»ç©
    mag1 += v1 * v1;         // å‘é‡1é•·åº¦å¹³æ–¹
    mag2 += v2 * v2;         // å‘é‡2é•·åº¦å¹³æ–¹
  }

  // é¤˜å¼¦ç›¸ä¼¼åº¦ = é»ç© / (é•·åº¦1 * é•·åº¦2)
  return dotProduct / (Math.sqrt(mag1) * Math.sqrt(mag2));
}

// ç¯„ä¾‹
cosineSimilarity(
  { "é¸": 0.5, "èª²": 0.5 },
  { "é¸": 0.3, "èª²": 0.3, "æœ‰": 0.4 }
)
// â†’ 0.707... (è¶Šæ¥è¿‘ 1 è¡¨ç¤ºè¶Šç›¸ä¼¼)
```

### 5.3 çŸ¥è­˜åº«æ ¼å¼

```txt
# knowledge_base.txt æ ¼å¼

[Academic] é¸èª²æœ‰å“ªäº›éšæ®µï¼Ÿ | å¸«å¤§é¸èª²ä¸»è¦åˆ†ã€Œåˆé¸ã€å’Œã€ŒåŠ é€€é¸ã€å…©éšæ®µ...

[Food] å¸«å¤§æœ‰ä»€éº¼å¿…åƒç¾é£Ÿï¼Ÿ | å¸«å¤§å•†åœˆæœ€å…·ä»£è¡¨æ€§çš„å®µå¤œæ˜¯å¸«åœ’é¹½é…¥é›...

[Lifestyle] åƒåŠ ç¤¾åœ˜æœ‰ä»€éº¼å¥½è™•ï¼Ÿ | èª²å¤–æ´»å‹•æ˜¯å¤§å­¸å­¸ç¿’ç”Ÿæ´»ä¸­éå¸¸é‡è¦çš„ä¸€ç’°...
```

---

## ğŸ¨ å…­ã€é—œéµåŠŸèƒ½å¯¦ä½œ

### 6.1 å¤šèªè¨€åˆ‡æ›

**å…¨å±€ç‹€æ…‹ + localStorage æŒä¹…åŒ–**

```javascript
// Context è¨­ç½®
const [language, setLanguage] = useState(() => {
  return localStorage.getItem('appLanguage') || 'en';
});

useEffect(() => {
  localStorage.setItem('appLanguage', language);
}, [language]);

// ä½¿ç”¨ç¯„ä¾‹
const Header = () => {
  const { language } = useLanguage();

  const text = {
    zh: { home: 'é¦–é ', boards: 'çœ‹æ¿' },
    en: { home: 'Home', boards: 'Boards' }
  };

  return <nav>{text[language].home}</nav>;
};
```

### 6.2 å¯¦æ™‚èŠå¤©å®¤

**Firestore onSnapshot + 30å¤©éæœŸæ©Ÿåˆ¶**

```javascript
const ChatWidget = ({ boardName }) => {
  const [messages, setMessages] = useState([]);

  useEffect(() => {
    // ç›£è½è¨Šæ¯
    const unsubscribe = listenToChatMessages(boardName, (msgs) => {
      setMessages(msgs);
    });

    return () => unsubscribe();
  }, [boardName]);

  const sendMessage = async (content) => {
    await sendChatMessage(
      boardName,
      userProfile.nickname,
      currentUser.uid,
      content
    );
  };

  return (
    <div>
      {messages.map(msg => (
        <div key={msg.id}>
          <strong>{msg.sender}:</strong> {msg.content}
        </div>
      ))}
      <input onSubmit={sendMessage} />
    </div>
  );
};
```

### 6.3 æ™ºæ…§é…å°ç³»çµ±

**åŸºæ–¼èˆˆè¶£ã€èªè¨€ã€æ™‚é–“çš„åŒ¹é…æ¼”ç®—æ³•**

```javascript
const executeMatching = (users, currentUser, matchType) => {
  // è¨ˆç®—é…å°åˆ†æ•¸
  const scores = users.map(user => {
    let score = 0;

    // èˆˆè¶£åŒ¹é… (40%)
    const commonInterests = intersection(
      currentUser.interests,
      user.interests
    );
    score += (commonInterests.length / 10) * 40;

    // èªè¨€äº’è£œ (30%)
    if (matchType === 'language') {
      if (currentUser.nativeLanguage === user.targetLanguage &&
          currentUser.targetLanguage === user.nativeLanguage) {
        score += 30;
      }
    }

    // æ™‚é–“åŒ¹é… (30%)
    const timeOverlap = calculateTimeOverlap(
      currentUser.availableTime,
      user.availableTime
    );
    score += timeOverlap * 30;

    return { user, score };
  });

  // æ’åºä¸¦è¿”å›
  return scores
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);
};
```

---

## ğŸš€ ä¸ƒã€éƒ¨ç½²æ¶æ§‹

### 7.1 å‰ç«¯éƒ¨ç½² (Vercel/Netlify)

```bash
# æ§‹å»º
npm run build

# éƒ¨ç½²é…ç½®
{
  "build": {
    "command": "npm run build",
    "output": "build"
  },
  "routes": [
    { "src": "/static/(.*)", "dest": "/static/$1" },
    { "src": "/(.*)", "dest": "/index.html" }
  ]
}
```

### 7.2 å¾Œç«¯éƒ¨ç½² (Render)

```yaml
# render.yaml
services:
  - type: web
    name: ntnu-talk-backend
    env: node
    buildCommand: npm install
    startCommand: node server.js
    envVars:
      - key: PERSPECTIVE_API_KEY
        sync: false
      - key: REMOVE_BG_API_KEY
        sync: false
      - key: PORT
        value: 10000
```

---

## ğŸ“Š å…«ã€æ•ˆèƒ½å„ªåŒ–

### 8.1 Firestore æŸ¥è©¢å„ªåŒ–

```javascript
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ç´¢å¼• + é™åˆ¶æ•¸é‡
const q = query(
  collection(db, 'posts'),
  where('boardName', '==', 'Food'),
  orderBy('createdAt', 'desc'),
  limit(20) // é™åˆ¶æ•¸é‡
);

// âŒ å£çš„åšæ³•ï¼šè¼‰å…¥æ‰€æœ‰æ•¸æ“š
const allPosts = await getDocs(collection(db, 'posts'));
```

### 8.2 åœ–ç‰‡å„ªåŒ–

```javascript
// Base64 è½‰ Blob æ¸›å°‘è¨˜æ†¶é«”ä½¿ç”¨
const base64ToBlob = (base64) => {
  const [header, data] = base64.split(',');
  const mime = header.match(/:(.*?);/)[1];
  const binary = atob(data);
  const array = new Uint8Array(binary.length);

  for (let i = 0; i < binary.length; i++) {
    array[i] = binary.charCodeAt(i);
  }

  return new Blob([array], { type: mime });
};
```

---

## ğŸ” ä¹ã€å®‰å…¨æ€§è€ƒé‡

### 9.1 Firebase å®‰å…¨è¦å‰‡

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ç”¨æˆ¶åªèƒ½è®€å–è‡ªå·±çš„è³‡æ–™
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth.uid == userId;
    }

    // è²¼æ–‡ï¼šå·²ç™»å…¥å¯è®€ï¼Œä½œè€…å¯å¯«
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.authorId;
    }
  }
}
```

### 9.2 API Key ä¿è­·

```javascript
// âŒ éŒ¯èª¤ï¼šæš´éœ²åœ¨å‰ç«¯
const API_KEY = "sk-1234567890";

// âœ… æ­£ç¢ºï¼šä½¿ç”¨å¾Œç«¯ä»£ç†
// å‰ç«¯ â†’ å¾Œç«¯ /moderation â†’ Google API
```

---

## ğŸ¯ åã€ç¸½çµ

### æŠ€è¡“äº®é»

1. **æ¨¡æ¿åŒ–è¨­è¨ˆ** - BoardTemplate é¿å…ä»£ç¢¼é‡è¤‡
2. **å¯¦æ™‚åŒæ­¥** - Firestore onSnapshot å¯¦ç¾å³æ™‚æ›´æ–°
3. **Context API** - è¼•é‡ç´šç‹€æ…‹ç®¡ç†
4. **RAG ç³»çµ±** - å‘é‡æª¢ç´¢å¢å¼· AI å›ç­”
5. **API ä»£ç†** - ä¿è­·æ•æ„Ÿ Key
6. **å¤šèªè¨€æ”¯æ´** - å®Œæ•´çš„ i18n å¯¦ç¾

### æ¶æ§‹å„ªå‹¢

- âœ… **å¯æ“´å±•æ€§** - æ–°å¢çœ‹æ¿åªéœ€ä¸€è¡Œä»£ç¢¼
- âœ… **å¯ç¶­è­·æ€§** - æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹
- âœ… **æ•ˆèƒ½å„ªåŒ–** - å¯¦æ™‚è¨‚é–± + æŸ¥è©¢å„ªåŒ–
- âœ… **å®‰å…¨æ€§** - Firebase è¦å‰‡ + API ä»£ç†
- âœ… **ç”¨æˆ¶é«”é©—** - å¯¦æ™‚æ›´æ–° + å¤šèªè¨€

### æ”¹é€²ç©ºé–“

1. åœ–ç‰‡å„²å­˜æ”¹ç”¨ Firebase Storage
2. å¯¦ç¾åˆ†é è¼‰å…¥ï¼ˆinfinite scrollï¼‰
3. æ·»åŠ å…¨æ–‡æœç´¢åŠŸèƒ½
4. ä½¿ç”¨ Redis å¿«å–ç†±é–€è²¼æ–‡
5. å‡ç´š RAG ä½¿ç”¨ OpenAI Embeddings

---

**è¬›è§£å®Œç•¢ï¼** ğŸ‰

æœ‰ä»»ä½•å•é¡Œæ­¡è¿æå•ï¼
